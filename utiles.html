<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My English Classroom Adventure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Fredoka',sans-serif;background-color:#e0f7fa;color:#004d40;margin:0;box-sizing:border-box}#modal-manager{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000}.modal-window{width:100%;height:100%;background-color:rgba(0,77,64,.7);display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box;opacity:1;transition:opacity .5s,visibility .5s}.modal-window.hidden{opacity:0;visibility:hidden;display:none}.modal-content{background:#fff;padding:30px 40px;border-radius:25px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2);border:5px solid #ffab91;width:90%;max-width:450px}.modal-content h2{color:#ff6f61;font-size:2.8em;margin:0 0 10px}.modal-content p,.story-text p{font-size:1.3em;color:#546e7a;margin-bottom:20px;line-height:1.6}#player-name-input{width:100%;padding:15px;font-family:'Fredoka',sans-serif;font-size:1.2em;border:2px solid #bcaaa4;border-radius:12px;box-sizing:border-box;text-align:center;margin-bottom:20px}#player-name-input:focus{outline:none;border-color:#ff6f61}.modal-button{font-family:'Fredoka',sans-serif;font-size:1.6em;font-weight:500;padding:15px 40px;border:none;background-color:#66bb6a;color:#fff;border-radius:15px;cursor:pointer;transition:transform .2s,background-color .2s}.modal-button:hover{background-color:#57a05a;transform:scale(1.05)}#game-container{width:100%;max-width:900px;background-color:#fff;border-radius:25px;padding:20px 30px;box-shadow:0 10px 20px rgba(0,0,0,.1);text-align:center;border:5px solid #ffcc80;margin:20px auto;box-sizing:border-box}.game-section{padding:10px}.game-section.hidden{display:none}.game-area{margin-top:20px;padding:20px;border-radius:15px}header h1{font-size:2.5em;color:#ff6f61;margin-bottom:10px}header p{font-size:1.2em;color:#546e7a}.progress-tracker{font-size:1.3em;font-weight:500;margin-top:15px;color:#00796b;background-color:#e8f5e9;padding:8px 15px;border-radius:20px;display:inline-block}#game-1-backpack .game-area{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:center;background-color:#f1f8e9}#objects-container{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;min-height:150px;flex:1;padding:10px}.object{font-size:4em;margin:15px;cursor:grab;transition:transform .2s,opacity .2s;position:relative}.object:hover{transform:scale(1.2) rotate(5deg)}.object.dragging{opacity:.5;transform:scale(.9)}#backpack{position:relative;width:150px;height:150px;display:flex;justify-content:center;align-items:center;transition:all .3s}#backpack svg{width:100%;height:100%;color:#ff8a65;transition:transform .3s}#backpack.drag-over svg{transform:scale(1.15);color:#66bb6a}#packed-items-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-wrap:wrap;justify-content:center;align-items:center;width:70%;height:60%;pointer-events:none}.packed-item{font-size:2.2em;margin:2px}.object.hidden{display:none}.command-bar{font-size:1.8em;font-weight:600;color:#d84315;margin:20px 0;padding:10px;background-color:#fff9c4;border-radius:15px;border:3px dashed #ffb74d}#game-2-find .game-area{display:flex;justify-content:center;align-items:center;padding:0;background-color:transparent}#find-scene{position:relative;width:100%;max-width:800px;height:400px;background:url(https://i.pinimg.com/originals/a3/57/3e/a3573e6a0815340a653428fa6930a662.jpg) no-repeat center center;background-size:cover;border-radius:15px;overflow:hidden;border:5px solid #a5d6a7}.findable-object{position:absolute;font-size:3em;cursor:pointer;transition:transform .2s}.findable-object:hover{transform:scale(1.2)}.found{animation:found-animation .5s ease-out}@keyframes found-animation{0%{transform:scale(1.2)}50%{transform:scale(1.5) rotate(15deg)}100%{transform:scale(1)}}#game-3-commands .game-area{display:flex;flex-wrap:wrap;justify-content:space-around;align-items:center;background-color:#f1f8e9}#command-scene{width:100%;display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap}.command-object{font-size:8em;cursor:pointer;transition:transform .3s;margin:20px}.command-object:hover{transform:scale(1.1)}.command-object.animated{animation:action-animation 1s ease-in-out}@keyframes action-animation{0%{transform:translateY(0) rotate(0)}50%{transform:translateY(-20px) rotate(10deg)}100%{transform:translateY(0) rotate(0)}}#final-success-message{text-align:center;padding:20px}#final-success-message h2{color:#66bb6a;font-size:3em}#final-success-message p{font-size:1.5em}#reset-button{font-family:'Fredoka',sans-serif;font-size:1.5em;padding:15px 30px;border:none;background-color:#ff6f61;color:#fff;border-radius:15px;cursor:pointer;transition:background-color .2s}#reset-button:hover{background-color:#e55a50}@media (max-width:600px){.modal-content h2{font-size:2em}.modal-content p{font-size:1.1em}#game-container{padding:15px}#game-1-backpack .game-area,#game-3-commands .game-area{flex-direction:column}.object{font-size:3em}#backpack{width:120px;height:120px}#find-scene{height:300px}.findable-object{font-size:2.5em}.command-object{font-size:6em}}
    </style>
</head>
<body>

    <div id="modal-manager">
        <div id="welcome-modal" class="modal-window">
            <div class="modal-content">
                <h2>¬°Welcome! üëã</h2>
                <p>What's your name?</p>
                <input type="text" id="player-name-input" placeholder="Write your name here" autocomplete="off">
                <button class="modal-button" data-next="story-1">Continue</button>
            </div>
        </div>
        <div id="story-1-modal" class="modal-window hidden">
            <div class="modal-content">
                <h2>Bucky's Adventure! üéí</h2>
                <div class="story-text"></div>
                <button class="modal-button" data-next="game-1">Start Mission!</button>
            </div>
        </div>
        <div id="story-2-modal" class="modal-window hidden">
            <div class="modal-content">
                <h2>Hide and Seek! üëÄ</h2>
                <div class="story-text"></div>
                <button class="modal-button" data-next="game-2">Let's find them!</button>
            </div>
        </div>
        <div id="story-3-modal" class="modal-window hidden">
             <div class="modal-content">
                <h2>Magic Words! ‚ú®</h2>
                <div class="story-text"></div>
                <button class="modal-button" data-next="game-3">Let's do magic!</button>
            </div>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <div id="game-1-backpack" class="game-section">
            <header>
                <h1>My English Classroom</h1>
                <p>¬°Hola, <span class="player-name"></span>! Arrastra los √∫tiles a la mochila.</p>
                <div class="progress-tracker">Objects Packed: 0 / 6</div>
            </header>
            <main class="game-area">
                <div id="objects-container">
                    <div class="object" draggable="true" id="pencil">‚úèÔ∏è</div>
                    <div class="object" draggable="true" id="book">üìñ</div>
                    <div class="object" draggable="true" id="scissors">‚úÇÔ∏è</div>
                    <div class="object" draggable="true" id="ruler">üìè</div>
                    <div class="object" draggable="true" id="glue">üß¥</div>
                    <div class="object" draggable="true" id="crayon">üñçÔ∏è</div>
                </div>
                <div id="backpack-container">
                    <div id="backpack">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.79,6.22A5.44,5.44,0,0,0,15,4H9a5.44,5.44,0,0,0-4.79,2.22L2,11.05V20a2,2,0,0,0,2,2H20a2,2,0,0,0,2-2V11.05ZM12,2.05A5.5,5.5,0,0,1,17.5,7.55V9H6.5V7.55A5.5,5.5,0,0,1,12,2.05ZM10,14a1,1,0,0,1,1-1h2a1,1,0,0,1,0,2H11A1,1,0,0,1,10,14Z"/></svg>
                        <div id="packed-items-display"></div>
                    </div>
                </div>
            </main>
        </div>
        <div id="game-2-find" class="game-section hidden">
            <header>
                <h1>Hide and Seek</h1>
                <div id="find-command" class="command-bar">Find the...</div>
            </header>
            <main class="game-area">
                <div id="find-scene">
                    <div class="findable-object" data-name="Crayon">üñçÔ∏è</div>
                    <div class="findable-object" data-name="Eraser">üßº</div>
                    <div class="findable-object" data-name="Glue">üß¥</div>
                    <div class="findable-object" data-name="Apple">üçé</div>
                </div>
            </main>
        </div>
        <div id="game-3-commands" class="game-section hidden">
            <header>
                <h1>Magic Words</h1>
                <div id="do-command" class="command-bar">Now...</div>
            </header>
            <main class="game-area">
                <div id="command-scene">
                    <div class="command-object" data-action="open">üìñ</div>
                    <div class="command-object" data-action="draw">‚úèÔ∏è</div>
                    <div class="command-object" data-action="glue">üß¥</div>
                </div>
            </main>
        </div>
        <div id="final-success-message" class="hidden">
            <h2>You are a Superstar, <span class="player-name"></span>! üåü</h2>
            <p>You completed all the missions!</p>
            <button id="reset-button">Play Again From Start</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GESTI√ìN GLOBAL ---
            let playerName = '';
            const synth = window.speechSynthesis;
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const gameContainer = document.getElementById('game-container');
            const modalManager = document.getElementById('modal-manager');

            // --- GESTI√ìN DE MODALES Y NARRATIVA ---
            const modals = { 'welcome': document.getElementById('welcome-modal'), 'story-1': document.getElementById('story-1-modal'), 'story-2': document.getElementById('story-2-modal'), 'story-3': document.getElementById('story-3-modal'), };
            const games = { 'game-1': document.getElementById('game-1-backpack'), 'game-2': document.getElementById('game-2-find'), 'game-3': document.getElementById('game-3-commands'), };

            modalManager.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-button')) {
                    const next = e.target.dataset.next;
                    handleFlow(next);
                }
            });
            
            function handleFlow(step) {
                Object.values(modals).forEach(m => m.classList.add('hidden'));
                Object.values(games).forEach(g => g.classList.add('hidden'));
                
                if (modals[step]) {
                    if(step === 'story-1') setupStory1(); 
                    if(step === 'story-2') setupStory2(); 
                    if(step === 'story-3') setupStory3();
                    modals[step].classList.remove('hidden');
                } else if (games[step]) {
                    modalManager.classList.add('hidden'); 
                    gameContainer.classList.remove('hidden'); 
                    games[step].classList.remove('hidden');
                    // Iniciar el juego correspondiente si es la primera vez
                    if (step === 'game-2') initGame2();
                    if (step === 'game-3') initGame3();
                }
            }

            function setupStory1() { playerName = document.getElementById('player-name-input').value.trim() || 'Superstar'; document.querySelectorAll('.player-name').forEach(span => span.textContent = playerName); modals['story-1'].querySelector('.story-text').innerHTML = `<p>¬°Hola, <strong>${playerName}</strong>! Soy Bucky, tu nueva mochila. ¬øMe ayudas a guardar a mis amigos?</p>`; }
            function setupStory2() { modals['story-2'].querySelector('.story-text').innerHTML = `<p>¬°Buen trabajo, <strong>${playerName}</strong>! ¬°Ahora vamos a jugar a las escondidas!</p>`; }
            function setupStory3() { modals['story-3'].querySelector('.story-text').innerHTML = `<p>¬°Eres un gran explorador, <strong>${playerName}</strong>! √öltima misi√≥n: ¬°las palabras m√°gicas!</p>`; }

            function playSound(type) {const o=audioContext.createOscillator();const g=audioContext.createGain();o.connect(g);g.connect(audioContext.destination);if(type==='pickup'){o.type='square';o.frequency.setValueAtTime(150,audioContext.currentTime);g.gain.setValueAtTime(0.1,audioContext.currentTime);}else if(type==='drop'){o.type='sine';o.frequency.setValueAtTime(440,audioContext.currentTime);g.gain.setValueAtTime(0.2,audioContext.currentTime);}o.start();o.stop(audioContext.currentTime+0.1);}
            function speak(text) { if(synth.speaking) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; synth.speak(u); }

            // --- L√ìGICA JUEGO 1: PACK YOUR BACKPACK ---
            const objectsGame1 = document.querySelectorAll('#game-1-backpack .object');
            const backpack = document.getElementById('backpack');
            const packedItemsContainer = document.getElementById('packed-items-display');
            const progressTracker1 = document.querySelector('#game-1-backpack .progress-tracker');
            let draggedObject = null;
            let objectsInBackpack = 0;

            objectsGame1.forEach(object => {
                object.addEventListener('dragstart', (e) => { 
                    e.dataTransfer.setData('text/plain', e.currentTarget.id);
                    e.dataTransfer.effectAllowed = 'move';
                    draggedObject = e.currentTarget;
                    playSound('pickup');
                    setTimeout(() => e.currentTarget.classList.add('dragging'), 0); 
                });
                object.addEventListener('dragend', (e) => { 
                    e.currentTarget.classList.remove('dragging');
                });
            });
            backpack.addEventListener('dragover', (e) => { e.preventDefault(); });
            backpack.addEventListener('dragenter', (e) => { e.preventDefault(); backpack.classList.add('drag-over'); });
            backpack.addEventListener('dragleave', () => { backpack.classList.remove('drag-over'); });
            backpack.addEventListener('drop', (e) => {
                e.preventDefault();
                backpack.classList.remove('drag-over');
                if (draggedObject && !draggedObject.classList.contains('packed')) {
                    playSound('drop');
                    packedItemsContainer.innerHTML += `<div class="packed-item">${draggedObject.innerHTML}</div>`;
                    draggedObject.classList.add('hidden', 'packed');
                    objectsInBackpack++;
                    progressTracker1.textContent = `Objects Packed: ${objectsInBackpack} / ${objectsGame1.length}`;
                    if (objectsInBackpack === objectsGame1.length) {
                        setTimeout(() => handleFlow('story-2'), 1000);
                    }
                }
            });

            // --- L√ìGICA JUEGO 2: FIND THE OBJECT ---
            let game2Initialized = false;
            function initGame2() {
                if(game2Initialized) return;
                game2Initialized = true;
                const findableObjects = Array.from(document.querySelectorAll('#game-2-find .findable-object'));
                const findCommand = document.getElementById('find-command');
                let objectsToFind = [...findableObjects].sort(() => 0.5 - Math.random());
                let currentObjectToFind = null;
                
                findableObjects.forEach(obj => {
                    obj.style.top = `${Math.random() * 80 + 10}%`;
                    obj.style.left = `${Math.random() * 80 + 10}%`;
                    obj.addEventListener('click', handleFindClick);
                });
                
                function nextObjectToFind() {
                    if (objectsToFind.length === 0) { setTimeout(() => handleFlow('story-3'), 1000); return; }
                    currentObjectToFind = objectsToFind.pop();
                    const nameToFind = currentObjectToFind.dataset.name;
                    findCommand.textContent = `Find the ${nameToFind}`;
                    speak(`Find the ${nameToFind}`);
                }

                function handleFindClick(e) {
                    if (e.currentTarget === currentObjectToFind) {
                        playSound('drop');
                        e.currentTarget.classList.add('found');
                        e.currentTarget.removeEventListener('click', handleFindClick);
                        setTimeout(nextObjectToFind, 1000);
                    } else { playSound('pickup'); }
                }
                nextObjectToFind();
            }

            // --- L√ìGICA JUEGO 3: LISTEN AND DO ---
            let game3Initialized = false;
            function initGame3() {
                if(game3Initialized) return;
                game3Initialized = true;
                const commandObjects = document.querySelectorAll('#game-3-commands .command-object');
                const doCommand = document.getElementById('do-command');
                const actions = [
                    { action: 'open', text: 'Open the book' },
                    { action: 'draw', text: 'Draw with the pencil' },
                    { action: 'glue', text: 'Use the glue' }
                ];
                let currentAction = 0;

                commandObjects.forEach(obj => {
                    obj.addEventListener('click', handleCommandClick);
                });

                function nextCommand() {
                    if (currentAction >= actions.length) {
                        setTimeout(() => {
                            games['game-3'].classList.add('hidden');
                            document.getElementById('final-success-message').classList.remove('hidden');
                        }, 1000);
                        return;
                    }
                    doCommand.textContent = actions[currentAction].text;
                    speak(actions[currentAction].text);
                }

                function handleCommandClick(e) {
                    if (e.currentTarget.dataset.action === actions[currentAction].action) {
                        playSound('drop');
                        e.currentTarget.classList.add('animated');
                        currentAction++;
                        setTimeout(() => {
                            e.currentTarget.classList.remove('animated');
                            nextCommand();
                        }, 1500);
                    } else { playSound('pickup'); }
                }
                nextCommand();
            }
            
            // --- L√ìGICA DE REINICIO ---
            document.getElementById('reset-button').addEventListener('click', () => { location.reload(); });
        });
    </script>
</body>
</html>
